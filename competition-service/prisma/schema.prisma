// ============================
// DATABASE CONNECTION
// ============================
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================
// MODELS
// ============================

// ----------------------------
// COMPETITION
// ----------------------------
model Competition {
  id             String   @id @default(uuid())
  name           String
  signupDeadline DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  groups Group[]
  matches Match[]
}

// ----------------------------
// GROUP (Group A, Group B, etc.)
// ----------------------------
model Group {
  id            String   @id @default(uuid())
  name          String
  competitionId String
  competition   Competition @relation(fields: [competitionId], references: [id])

  teams  Team[]
  rounds Round[]
  matches Match[]
}

// ----------------------------
// TEAM (Brazil, Argentina, etc.)
// ----------------------------
model Team {
  id       String @id @default(uuid())
  name     String
  fifaCode String @unique
  groupId  String
  group    Group @relation(fields: [groupId], references: [id])

  homeMatches Match[] @relation("HomeTeam")
  awayMatches Match[] @relation("AwayTeam")
}

// ----------------------------
// ROUND (1, 2, 3 â€“ Only for Group Stage)
// ----------------------------
model Round {
  id       String   @id @default(uuid())
  roundNumber Int
  groupId  String
  group    Group @relation(fields: [groupId], references: [id])

  matches Match[]
}

// ----------------------------
// MATCH
// ----------------------------
model Match {
  id          String   @id @default(uuid())
  phase       Phase
  startTime   DateTime
  status      MatchStatus @default(SCHEDULED)

  // Relationships
  homeTeamId  String
  homeTeam    Team @relation("HomeTeam", fields: [homeTeamId], references: [id])

  awayTeamId  String
  awayTeam    Team @relation("AwayTeam", fields: [awayTeamId], references: [id])

  groupId     String? 
  group       Group? @relation(fields: [groupId], references: [id])

  roundId     String?
  round       Round? @relation(fields: [roundId], references: [id])

  competitionId String
  competition   Competition @relation(fields: [competitionId], references: [id])

  // Final Score (90 minutes)
  homeScore   Int?
  awayScore   Int?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  predictions Prediction[]
}

// ENUMS
enum MatchStatus {
  SCHEDULED
  ONGOING
  FINISHED
}

enum Phase {
  GROUP
  ROUND_OF_16
  QUARTERS
  SEMIS
  THIRD_PLACE
  FINAL
}

// ----------------------------
// PREDICTION
// ----------------------------
model Prediction {
  id        String  @id @default(uuid())
  userId    String  // comes from auth-service
  matchId   String
  match     Match @relation(fields: [matchId], references: [id])

  predictedHomeScore Int
  predictedAwayScore Int

  locked    Boolean @default(false)
  lockedAt  DateTime?

  pointsAwarded Int? // 0, 1, 2, 3, 5 (null if not scored yet)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, matchId])
}
